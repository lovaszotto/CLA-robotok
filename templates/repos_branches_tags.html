<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Letölthető robotok</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1 { color: #2c3e50; }
        .repo { margin-bottom: 2em; }
        .branches, .tags { margin-left: 2em; }
        .section-title { font-weight: bold; margin-top: 0.5em; }
        ul { list-style-type: disc; }
    </style>
</head>
<body>
    <h1>Letölthető robotok</h1>
    <div id="repos-container">
        Betöltés...
    </div>
    <script>
        fetch('/api/repos_branches_tags')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('repos-container');
                container.innerHTML = '';
                if (data.length === 0) {
                    container.innerHTML = '<p>Nincs elérhető repository.</p>';
                    return;
                }
                data.forEach(repo => {
                    const repoDiv = document.createElement('div');
                    repoDiv.className = 'repo';
                    repoDiv.innerHTML = `<h2>${repo.name}</h2>`;

                    const releaseNameByTag = repo.release_name_by_tag || {};
                    const releaseDateByTag = repo.release_date_by_tag || {};

                    const tagDateMs = (t) => {
                        const raw = releaseDateByTag && releaseDateByTag[t] ? String(releaseDateByTag[t]) : '';
                        const d = raw ? new Date(raw) : null;
                        const ms = (d && !isNaN(d.getTime())) ? d.getTime() : 0;
                        return ms;
                    };

                    const sortTagsNewestFirst = (arr) => {
                        const list = Array.isArray(arr) ? arr.slice() : [];
                        list.sort((a, b) => {
                            const dm = tagDateMs(b) - tagDateMs(a);
                            if (dm !== 0) return dm;
                            return String(b).localeCompare(String(a));
                        });
                        return list;
                    };

                    const formatTag = (t) => {
                        const rn = releaseNameByTag && releaseNameByTag[t] ? releaseNameByTag[t] : '';
                        const rdRaw = releaseDateByTag && releaseDateByTag[t] ? releaseDateByTag[t] : '';
                        const rd = rdRaw ? String(rdRaw).slice(0, 10) : '';
                        if (rn && rd) return `${t} — ${rn} — ${rd}`;
                        if (rn) return `${t} — ${rn}`;
                        if (rd) return `${t} — ${rd}`;
                        return `${t}`;
                    };

                    // Branchek
                    const branches = repo.branches && repo.branches.length ?
                        `<div class='branches'><span class='section-title'>Branchek:</span><ul>${repo.branches.map(b => `<li>${b}</li>`).join('')}</ul></div>` :
                        `<div class='branches'><span class='section-title'>Nincs branch.</span></div>`;

                    // Tag-ek
                    const tags = repo.tags && repo.tags.length ?
                        `<div class='tags'><span class='section-title'>Tag-ek:</span><ul>${sortTagsNewestFirst(repo.tags).map(t => `<li>${formatTag(t)}</li>`).join('')}</ul></div>` :
                        `<div class='tags'><span class='section-title'>Nincs tag.</span></div>`;

                    repoDiv.innerHTML += branches + tags;
                    container.appendChild(repoDiv);
                });
            })
            .catch(err => {
                document.getElementById('repos-container').innerHTML = 'Hiba történt az adatok betöltésekor.';
            });
    </script>
</body>
</html>
