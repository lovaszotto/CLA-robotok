<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Segíthetünk? - Robot Kezelő v2.1</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: white; min-height: 100vh; }
.main-container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
.page-header { background: linear-gradient(135deg, #0d6efd 0%, #3b82f6 50%, #93c5fd 100%); color: white; padding: 30px; display: flex; align-items: center; justify-content: space-between; }
.page-header .header-content { display: flex; flex-direction: column; align-items: center; flex: 1; }
.page-header h1 { margin: 0; font-size: 2.5rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.timestamp { margin-top: 10px; opacity: 0.9; font-size: 0.95rem; }
.nav-tabs { border-bottom: 3px solid #0d6efd; background: #f8f9fa; }
.nav-tabs .nav-link { color: #495057; border: none; padding: 15px 25px; font-weight: 600; border-radius: 0; }
.nav-tabs .nav-link.active { background: linear-gradient(135deg, #0d6efd 0%, #3b82f6 50%, #93c5fd 100%); color: white; border-bottom: 3px solid #0d6efd; }
.nav-tabs .nav-link:hover { background: linear-gradient(135deg, #93c5fd 0%, #e7f3ff 100%); color: #0d6efd; }
.tab-content { padding: 30px; }
.card, .repo-card {
    border: 2px solid #888 !important;
}
.card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #dee2e6 !important; }
.actions { text-align: center; margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; }
.btn-custom { background: linear-gradient(135deg, #0d6efd 0%, #3b82f6 50%, #93c5fd 100%); color: white; padding: 12px 25px; border: none; border-radius: 8px; margin: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
.btn-custom:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); background: linear-gradient(135deg, #004085 0%, #0d6efd 50%, #93c5fd 100%); }
.repo-card { 
    transition: all 0.3s ease; 
    border: 1px solid #dee2e6 !important; 
    background: linear-gradient(135deg, #ffffff 0%, #fdf2f2 100%) !important;
}
.repo-card:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 8px 25px rgba(220,53,69,0.25) !important; 
    border-color: #0d6efd; 
}
.repo-card .card-header { 
    background: linear-gradient(135deg, #0d6efd 0%, #3b82f6 50%, #0056b3 100%) !important; 
    color: white !important;
}
.repo-card .card-title a:hover { text-decoration: underline !important; }
.branches-container { max-height: 300px; overflow-y: auto; }
.branch-checkbox { padding: 8px 12px; margin: 2px 0; border-radius: 6px; transition: background-color 0.2s; }
.branch-checkbox:hover { background-color: #f8f9fa; }
.branch-checkbox input:checked + label { font-weight: bold; color: #0d6efd; }
/* Always show a border for checkboxes, even when not checked */
.branch-checkbox .form-check-input[type="checkbox"] {
    border: 2px solid #888;
    background-color: #fff;
    box-shadow: none;
    -webkit-appearance: checkbox;
         -moz-appearance: checkbox;
                    appearance: checkbox;
}
.branch-checkbox .form-check-input[type="checkbox"]:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25);
}
/* Always show a border for checkboxes, even when not checked */
/* Widen and emphasize switches for robot selection */
#repoSearch:focus, #branchFilter:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); }
.input-group-text.bg-primary { background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%) !important; }
.input-group-text.bg-success { background: linear-gradient(135deg, #0d6efd 0%, #3b82f6 50%, #93c5fd 100%) !important; }
.hidden { display: none !important; }
.spinning { animation: spin 1s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="main-container">
<div class="page-header">
<div class="header-content">
<h1><i class="bi bi-robot"></i> Segíthetünk?</h1>
</div>
</div>
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="available-tab" data-bs-toggle="tab" data-bs-target="#available-pane" type="button" role="tab">
<i class="bi bi-download"></i> Letölthető robotok
</button>
</li>
<button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-pane" type="button" role="tab">
<i class="bi bi-list-task"></i> Eredmények
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-pane" type="button" role="tab">
<i class="bi bi-info-circle"></i> Információ
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
<i class="bi bi-gear"></i> Beállítások
</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="exit-tab" data-bs-toggle="tab" data-bs-target="#exit-pane" type="button" role="tab">
<i class="bi bi-box-arrow-right"></i> Kilépés
</button>
</li>
</ul>
<div class="tab-content" id="mainTabContent">
<!-- Futtatható robotok TAB -->
<div class="tab-pane fade show active" id="download-pane" role="tabpanel">
    <!-- Keresés és szűrés -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-primary text-white"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="repoSearch" placeholder="Repository keresése..." onkeyup="filterRepos()">
            <!-- Futtatható robotok TAB and all related UI removed -->
            </div>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-success text-white"><i class="bi bi-filter"></i></span>
                <input type="text" class="form-control" id="branchFilterAvailable" placeholder="Robot szűrése..." onkeyup="filterReposAvailable()">
            </div>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <div class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>
                Jelölje be a futtatni kívánt robotokat
            </div>
        </div>
    </div>
    <!-- Branch név label eltávolítva -->
    <!-- Repository kártyák -->
    <div class="row" id="repoContainerAvailable">
    
        
        <div class="col-lg-6 col-xl-4 mb-4 repo-item-available" data-repo-name="CLA-robotok">
            <div class="card repo-card h-100">
                <div class="card-header text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-github"></i>
                        <a href="https://github.com/lovaszotto/CLA-robotok" target="_blank" class="text-white text-decoration-none">
                            CLA-robotok
                        </a>
                    </h5>
                    
                    <small class="opacity-75">2025-10-16</small>
                    
                </div>
                <div class="card-body">
                    <p class="card-text">Segéd robotok</p>
                    <h6 class="mt-3"><i class="bi bi-git"></i> Robotok:</h6>
                    <div class="branches-container">
                        
                            <div class="branch-checkbox">
                                <label class="form-check-label ms-2">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    CLA-ssistant
                                </label>
                             </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
    
        
        <div class="col-lg-6 col-xl-4 mb-4 repo-item-available" data-repo-name="CPS-Robotok">
            <div class="card repo-card h-100">
                <div class="card-header text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-github"></i>
                        <a href="https://github.com/lovaszotto/CPS-Robotok" target="_blank" class="text-white text-decoration-none">
                            CPS-Robotok
                        </a>
                    </h5>
                    
                    <small class="opacity-75">2025-10-09</small>
                    
                </div>
                <div class="card-body">
                    <p class="card-text">VBÜ számára készült robotok</p>
                    <h6 class="mt-3"><i class="bi bi-git"></i> Robotok:</h6>
                    <div class="branches-container">
                        
                            <div class="branch-checkbox">
                                <input type="checkbox" class="form-check-input robot-checkbox-available me-2"
                                       id="branch-available-CPS-Robotok-CPS-Mezo-ellenor" 
                                       data-repo="CPS-Robotok" 
                                       data-branch="CPS-Mezo-ellenor"
                                       onchange="handleAvailableRobotToggle(this)">
                                <label class="form-check-label ms-2" for="branch-available-CPS-Robotok-CPS-Mezo-ellenor">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    CPS-Mezo-ellenor
                                </label>
                             </div>
                        
                            <div class="branch-checkbox">
                                <input type="checkbox" class="form-check-input robot-checkbox-available me-2"
                                       id="branch-available-CPS-Robotok-ORIANA-Mezo-ellenor" 
                                       data-repo="CPS-Robotok" 
                                       data-branch="ORIANA-Mezo-ellenor"
                                       onchange="handleAvailableRobotToggle(this)">
                                <label class="form-check-label ms-2" for="branch-available-CPS-Robotok-ORIANA-Mezo-ellenor">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    ORIANA-Mezo-ellenor
                                </label>
                             </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
    
        
        <div class="col-lg-6 col-xl-4 mb-4 repo-item-available" data-repo-name="IKK-Robotok">
            <div class="card repo-card h-100">
                <div class="card-header text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-github"></i>
                        <a href="https://github.com/lovaszotto/IKK-Robotok" target="_blank" class="text-white text-decoration-none">
                            IKK-Robotok
                        </a>
                    </h5>
                    
                    <small class="opacity-75">2025-10-09</small>
                    
                </div>
                <div class="card-body">
                    <p class="card-text">Innovatív Képzéstámogató Központ számára készült robotok</p>
                    <h6 class="mt-3"><i class="bi bi-git"></i> Robotok:</h6>
                    <div class="branches-container">
                        
                            <div class="branch-checkbox">
                                <input type="checkbox" class="form-check-input robot-checkbox-available me-2"
                                       id="branch-available-IKK-Robotok-IKK01_Duplikáció-ellenőrzés" 
                                       data-repo="IKK-Robotok" 
                                       data-branch="IKK01_Duplikáció-ellenőrzés"
                                       onchange="handleAvailableRobotToggle(this)">
                                <label class="form-check-label ms-2" for="branch-available-IKK-Robotok-IKK01_Duplikáció-ellenőrzés">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    IKK01_Duplikáció-ellenőrzés
                                </label>
                             </div>
                        
                            <div class="branch-checkbox">
                                <input type="checkbox" class="form-check-input robot-checkbox-available me-2"
                                       id="branch-available-IKK-Robotok-IKK02_Formai-Ellenorzesek" 
                                       data-repo="IKK-Robotok" 
                                       data-branch="IKK02_Formai-Ellenorzesek"
                                       onchange="handleAvailableRobotToggle(this)">
                                <label class="form-check-label ms-2" for="branch-available-IKK-Robotok-IKK02_Formai-Ellenorzesek">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    IKK02_Formai-Ellenorzesek
                                </label>
                             </div>
                        
                            <div class="branch-checkbox">
                                <input type="checkbox" class="form-check-input robot-checkbox-available me-2"
                                       id="branch-available-IKK-Robotok-IKK03_Web-ellenőrzés" 
                                       data-repo="IKK-Robotok" 
                                       data-branch="IKK03_Web-ellenőrzés"
                                       onchange="handleAvailableRobotToggle(this)">
                                <label class="form-check-label ms-2" for="branch-available-IKK-Robotok-IKK03_Web-ellenőrzés">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    IKK03_Web-ellenőrzés
                                </label>
                             </div>
                        
                            <div class="branch-checkbox">
                                <input type="checkbox" class="form-check-input robot-checkbox-available me-2"
                                       id="branch-available-IKK-Robotok-IKK04-Dokumentum-WEB-Ellenőrzés" 
                                       data-repo="IKK-Robotok" 
                                       data-branch="IKK04-Dokumentum-WEB-Ellenőrzés"
                                       onchange="handleAvailableRobotToggle(this)">
                                <label class="form-check-label ms-2" for="branch-available-IKK-Robotok-IKK04-Dokumentum-WEB-Ellenőrzés">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    IKK04-Dokumentum-WEB-Ellenőrzés
                                </label>
                             </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
    
        
        <div class="col-lg-6 col-xl-4 mb-4 repo-item-available" data-repo-name="KBSZ-robotok">
            <div class="card repo-card h-100">
                <div class="card-header text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-github"></i>
                        <a href="https://github.com/lovaszotto/KBSZ-robotok" target="_blank" class="text-white text-decoration-none">
                            KBSZ-robotok
                        </a>
                    </h5>
                    
                    <small class="opacity-75">2025-11-06</small>
                    
                </div>
                <div class="card-body">
                    <p class="card-text">Közbeszerzési értesítőt kezelő robotok</p>
                    <h6 class="mt-3"><i class="bi bi-git"></i> Robotok:</h6>
                    <div class="branches-container">
                        
                            <div class="branch-checkbox">
                                <input type="checkbox" class="form-check-input robot-checkbox-available me-2"
                                       id="branch-available-KBSZ-robotok-KB01-Közbeszerzési-Értesítő" 
                                       data-repo="KBSZ-robotok" 
                                       data-branch="KB01-Közbeszerzési-Értesítő"
                                       onchange="handleAvailableRobotToggle(this)">
                                <label class="form-check-label ms-2" for="branch-available-KBSZ-robotok-KB01-Közbeszerzési-Értesítő">
                                    <i class="bi bi-download text-secondary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Letölthető"></i>
                                    KB01-Közbeszerzési-Értesítő
                                </label>
                             </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
    
        
    
    </div>
</div>
<div class="tab-pane fade" id="executable-pane" role="tabpanel">
<div class="d-flex justify-content-between align-items-center mb-3">
<h3 class="mb-0"><i class="bi bi-play-circle-fill text-success"></i> Kiválasztott Robotok Futtatása</h3>
<div id="executionButtons" style="display: none;">
        <button class="btn btn-outline-secondary btn-lg me-2" onclick="clearSelection()">
            <i class="bi bi-x-circle"></i> Összes visszavonása
        </button>
    <button class="btn btn-primary btn-lg me-2" onclick="installSelectedRobots()">
        <i class="bi bi-download"></i> Kijelöltek letöltése
    </button>
        <button class="btn btn-success btn-lg" onclick="executeAllRobots()">
            <i class="bi bi-play-fill"></i> Kijelöltek futtatása
        </button>
</div>
</div>
</div>
<div class="tab-pane fade" id="info-pane" role="tabpanel">
<h3><i class="bi bi-info-circle-fill text-info"></i> Rendszer Információk</h3>
<div class="row">
<div class="col-md-6">
<div class="card">
<div class="card-header text-white" style="background: linear-gradient(135deg, #0d6efd, #0056b3);">
<h5><i class="bi bi-laptop"></i> Rendszer</h5>
</div>
<div class="card-body">
<ul class="list-unstyled">
<li><strong>Platform:</strong> Flask Web App</li>
<li><strong>Python verzió:</strong> 3.x</li>
<span class="input-group-text"><i class="bi bi-search"></i></span>
<input type="text" class="form-control" id="searchResults" placeholder="Keresés robot vagy branch szerint...">
</div>
</div>
<div class="col-md-3">
<select class="form-select" id="statusFilter">
<option value="">Összes státusz</option>
<option value="success">Sikeres</option>
<option value="failed">Sikertelen</option>
</select>
</div>
<div class="col-md-3">
<input type="date" class="form-control" id="dateFilter" title="Szűrés dátum szerint">
</div>
<div class="col-md-2">
<button class="btn btn-outline-danger w-100" onclick="refreshResults()">
<i class="bi bi-arrow-clockwise"></i> Frissítés
</button>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-hover">
<thead class="table-dark">
<tr>
<th onclick="sortResults('timestamp')">
<i class="bi bi-calendar"></i> Időpont 
<span class="sort-indicator" id="sort-timestamp"></span>
</th>
<th onclick="sortResults('repo')">
<i class="bi bi-github"></i> Repository 
<span class="sort-indicator" id="sort-repo"></span>
</th>
<th onclick="sortResults('branch')">
<i class="bi bi-git"></i> Branch 
<span class="sort-indicator" id="sort-branch"></span>
</th>
<th onclick="sortResults('status')">
<i class="bi bi-check-circle"></i> Státusz 
<span class="sort-indicator" id="sort-status"></span>
</th>
<th><i class="bi bi-folder"></i> Eredmények</th>
<th><i class="bi bi-gear"></i> Műveletek</th>
</tr>
</thead>
<tbody id="resultsTableBody">
<tr>
<td colspan="6" class="text-center text-muted py-4">
<i class="bi bi-hourglass-split"></i> Eredmények betöltése...
</td>
</tr>
</tbody>
</table>
</div>
<div class="d-flex justify-content-between align-items-center mt-3">
<div>
<span class="text-muted" id="resultsInfo">Összesen: 0 eredmény</span>
</div>
<nav>
<ul class="pagination pagination-sm" id="resultsPagination">
<!-- Dinamikusan generált lapozó -->
</ul>
</nav>
</div>
</div>
</div>
</div>
<div class="tab-pane fade" id="exit-pane" role="tabpanel">
<div class="text-center mt-5">
<h3><i class="bi bi-box-arrow-right text-danger"></i> Kilépés</h3>
<p class="lead mb-4">Biztos, hogy ki szeretne lépni az alkalmazásból?</p>
<div class="d-grid gap-2 d-md-block">
<button id="exitButton" class="btn btn-danger btn-lg" onclick="exitApplication()">
<i class="bi bi-box-arrow-right"></i> Kilépés
</button>
<button class="btn btn-secondary btn-lg" onclick="cancelExit()">
<i class="bi bi-arrow-left"></i> Mégse
</button>
</div>
</div>
</div>
</div>
</div>
<!-- jQuery és Bootstrap JavaScript -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>


function saveSettings() {
    const settings = {
        darkMode: document.getElementById('darkMode').checked,
        compactView: document.getElementById('compactView').checked,
        pageSize: document.getElementById('pageSize').value,
        executionMode: document.getElementById('executionMode').value,
        timeout: document.getElementById('timeout').value,
        generateReport: document.getElementById('generateReport').checked
        // sandboxMode-ot NEM mentjük localStorage-ba, mindig a backend a forrás
    };
    
    localStorage.setItem('robotManagerSettings', JSON.stringify(settings));
    alert('Beállítások mentve!');
}

function resetSettings() {
    document.getElementById('darkMode').checked = false;
    document.getElementById('compactView').checked = false;
    document.getElementById('pageSize').value = '10';
    document.getElementById('executionMode').value = 'sequential';
    document.getElementById('timeout').value = '300';
    document.getElementById('generateReport').checked = true;
    document.getElementById('sandboxMode').checked = false;
    
    // Sandbox mode visszaállítása a backend-en is
    updateSandboxMode();
    
    localStorage.removeItem('robotManagerSettings');
    alert('Beállítások visszaállítva!');
}

function loadSettings() {
    const savedSettings = localStorage.getItem('robotManagerSettings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        document.getElementById('darkMode').checked = settings.darkMode || false;
        document.getElementById('compactView').checked = settings.compactView || false;
        document.getElementById('pageSize').value = settings.pageSize || '10';
        document.getElementById('executionMode').value = settings.executionMode || 'sequential';
        document.getElementById('timeout').value = settings.timeout || '300';
        document.getElementById('generateReport').checked = settings.generateReport !== undefined ? settings.generateReport : true;
        // sandboxMode-ot NEM töltjük a localStorage-ből, mindig a backend a forrás
    }
    
    // Sandbox mode betöltése a backend-ről (ez a mindig aktuális állapot)
    loadCurrentSandboxMode();
}

// Sandbox Mode kezelés
function updateSandboxMode() {
    const isEnabled = document.getElementById('sandboxMode').checked;
    
    fetch('/api/set_sandbox_mode', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },

        // ...existing code...
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toast = toastContainer.lastElementChild;
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Automatikus törlés a toast eltűnése után
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Státusz segédfüggvények
function getStatusIcon(returnCode) {
    switch(returnCode) {
        case 0: return '<i class="bi bi-check-circle-fill text-success"></i>';
        case null:
        case undefined: return '<i class="bi bi-hourglass-split text-warning"></i>';
        default: return '<i class="bi bi-x-circle-fill text-danger"></i>';
    }
}

function getStatusText(returnCode) {
    switch(returnCode) {
        case 0: return 'Sikeres';
        case null:
        case undefined: return 'Várakozás';
        default: return 'Sikertelen';
    }
}

function getStatusClass(returnCode) {
    switch(returnCode) {
        case 0: return 'alert-success';
        case null:
        case undefined: return 'alert-warning';
        default: return 'alert-danger';
    }
}

// Kilépés funkciók
function exitApplication() {
    if (!confirm('Biztos, hogy ki szeretnél lépni és leállítani a szervert?')) {
        return;
    }

    const exitBtn = document.getElementById('exitButton');
    if (exitBtn) {
        exitBtn.disabled = true;
        exitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Leállítás...';
    }

    showToast('Kilépés folyamatban, a szerver leáll.', 'info');

    fetch('/shutdown', { method: 'POST' })
        .then(() => {
            showToast('A szerver leállt, az ablak bezáródik.', 'success');
        })
        .catch((error) => {
            console.warn('Kilépés közbeni hiba:', error);
            showToast('Kilépés közben hiba történt. Ha az ablak nyitva marad, zárd be kézzel.', 'warning');
        })
        .finally(() => {
            setTimeout(function() {
                try {
                    window.open('', '_self');
                    window.close();
                } catch (e) {
                    console.warn('A böngésző nem engedte bezárni az ablakot:', e);
                }
                document.body.innerHTML = '<div class="text-center mt-5"><h1>Az alkalmazás bezárult</h1><p>Ha az ablak nyitva marad, zárd be kézzel ezt a böngészőfület.</p></div>';
            }, 350);
        });
}

function cancelExit() {
    // Visszatérés az első tabra
    const firstTab = document.querySelector('#download-tab');
    if (firstTab) {
        firstTab.click();
    }
}

// Tab-ok robotszámainak frissítése
function updateTabCounts() {
    try {
        // Futtatható robotok számának frissítése
        const runnableRobots = document.querySelectorAll('#repoContainer .robot-checkbox').length;
        const downloadTab = document.getElementById('download-tab');
        if (downloadTab) {
            downloadTab.innerHTML = '<i class="bi bi-robot"></i> Futtatható robotok (' + runnableRobots + ')';
        }

        // Letölthető robotok számának frissítése
        const availableRobots = document.querySelectorAll('#repoContainerAvailable .robot-checkbox-available').length;
        const availableTab = document.getElementById('available-tab');
        if (availableTab) {
            availableTab.innerHTML = '<i class="bi bi-download"></i> Letölthető robotok (' + availableRobots + ')';
        }

        // Futtatás tab robotok számának frissítése
        const selectedRobots = getSelectedRobots().length;
        const executableTab = document.getElementById('executable-tab');
        if (executableTab) {
            executableTab.innerHTML = '<i class="bi bi-play-circle"></i> Futtatás (' + selectedRobots + ')';
        }
    } catch (error) {
        console.warn('Tab számok frissítése sikertelen:', error);
    }
}

// Oldal betöltésekor
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    updateRunButton();
    updateTabCounts();

    // Fallback: Exit gomb eseménykezelője id alapján
    try {
        var exitBtn = document.getElementById('exitButton');
        if (exitBtn && typeof exitApplication === 'function') {
            exitBtn.addEventListener('click', function(ev){ ev.preventDefault(); exitApplication(); });
        }
    } catch(e) { /* ignore */ }
});

// Close the external results window when 'Visszatérés' is clicked in the modal
document.addEventListener('DOMContentLoaded', function() {
    const returnBtn = document.getElementById('resultsModalReturn');
    if (returnBtn) {
        returnBtn.addEventListener('click', function() {
            try {
                if (window._lastResultsWindow && !window._lastResultsWindow.closed) {
                    window._lastResultsWindow.close();
                }
            } catch (e) { /* ignore */ }
        });
    }
});

// Checkbox változásokra figyelés
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('robot-checkbox')) {
        updateRunButton();
    }
});

// Eredmények kezelése
let currentPage = 1;
let currentSort = 'timestamp';
let currentOrder = 'desc';

function loadResults(page = 1, search = '', statusFilter = '', dateFilter = '') {
    currentPage = page;
    
    const params = new URLSearchParams({
        page: page,
        per_page: 10,
        search: search,
        status: statusFilter,
        date: dateFilter,
        sort: currentSort,
        order: currentOrder
    });
    
    fetch(`/api/results?${params}`)
    .then(response => response.json())
    .then(data => {
        displayResults(data.results);
        displayPagination(data.pagination);
        updateResultsInfo(data.pagination);
    })
    .catch(err => {
        console.error('Eredmények betöltése sikertelen:', err);
        document.getElementById('resultsTableBody').innerHTML = `
            <tr><td colspan="6" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle"></i> Hiba az eredmények betöltése során
            </td></tr>
        `;
    });
}

function displayResults(results) {
    const tbody = document.getElementById('resultsTableBody');
    if (results.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="6" class="text-center text-muted py-4">
                <i class="bi bi-inbox"></i> Nincs megjeleníthető eredmény
            </td></tr>
        `;
        return;
    }
    
    // Egyszerűsített megjelenítés HTML string concatenation-nal
    let htmlContent = '';
    results.forEach(result => {
        const statusBadge = result.status === 'success' 
            ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Sikeres</span>'
            : '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Sikertelen</span>';
            
        const typeBadge = result.type === 'bulk'
            ? '<span class="badge bg-info ms-1">Tömeges</span>'
            : '<span class="badge bg-secondary ms-1">Egyedi</span>';

        const resultsDisplay = result.results_dir 
            ? '<small class="text-muted">' + result.results_dir + '</small>' 
            : '-';

        // Use data-* attributes with encoded values to avoid inline JS quoting issues
        const encDir = encodeURIComponent(result.results_dir || '');
        const actionButton = result.results_dir
            ? '<button class="btn btn-sm btn-success" data-results-enc="' + encDir + '" onclick="openResults(decodeURIComponent(this.dataset.resultsEnc))" title="Megnyitás új ablakban"><i class="bi bi-eye"></i></button>'
            : '<button class="btn btn-sm btn-outline-secondary" data-result-id="' + (result.id || '') + '" onclick="viewDetails(this.dataset.resultId)" title="Részletek"><i class="bi bi-eye"></i></button>';
            
        htmlContent += '<tr>' +
            '<td>' + result.timestamp + typeBadge + '</td>' +
            '<td><i class="bi bi-github"></i> ' + result.repo + '</td>' +
            '<td><i class="bi bi-git"></i> ' + result.branch + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td>' + resultsDisplay + '</td>' +
            '<td>' + actionButton + '</td>' +
            '</tr>';
    });
    
    tbody.innerHTML = htmlContent;

    // Re-initialize Bootstrap tooltips for new elements
    setTimeout(() => {
        const tList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tList.forEach(function (el) { try { new bootstrap.Tooltip(el); } catch(e) {} });
    }, 10);
}

function displayPagination(pagination) {
    const nav = document.getElementById('resultsPagination');
    if (pagination.pages <= 1) {
        nav.innerHTML = '';
        return;
    }
    
    let paginationHtml = '';
    
    // Előző oldal
    if (pagination.page > 1) {
        paginationHtml += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadResults(${pagination.page - 1}, getCurrentSearch(), getCurrentStatusFilter(), getCurrentDateFilter())">Előző</a>
            </li>
        `;
    }
    
    // Oldalszámok
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHtml += `
            <li class="page-item ${i === pagination.page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadResults(${i}, getCurrentSearch(), getCurrentStatusFilter(), getCurrentDateFilter())">${i}</a>
            </li>
        `;
    }
    
    // Következő oldal
    if (pagination.page < pagination.pages) {
        paginationHtml += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadResults(${pagination.page + 1}, getCurrentSearch(), getCurrentStatusFilter(), getCurrentDateFilter())">Következő</a>
            </li>
        `;
    }
    
    nav.innerHTML = paginationHtml;
}

function updateResultsInfo(pagination) {
    const info = document.getElementById('resultsInfo');
    const start = (pagination.page - 1) * pagination.per_page + 1;
    const end = Math.min(start + pagination.per_page - 1, pagination.total);
    info.textContent = `${start}-${end} / ${pagination.total} eredmény (${pagination.page}. oldal)`;
}

function getCurrentSearch() {
    return document.getElementById('searchResults').value;
}

function getCurrentStatusFilter() {
    return document.getElementById('statusFilter').value;
}

function getCurrentDateFilter() {
    return document.getElementById('dateFilter').value;
}

function refreshResults() {
    loadResults(1, getCurrentSearch(), getCurrentStatusFilter(), getCurrentDateFilter());
}

function sortResults(column) {
    if (currentSort === column) {
        currentOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    } else {
        currentSort = column;
        currentOrder = 'desc';
    }
    
    // Rendezési indikátorok frissítése
    document.querySelectorAll('.sort-indicator').forEach(el => el.textContent = '');
    document.getElementById(`sort-${column}`).textContent = currentOrder === 'desc' ? '↓' : '↑';
    
    loadResults(currentPage, getCurrentSearch(), getCurrentStatusFilter(), getCurrentDateFilter());
}

function viewDetails(resultId) {
    alert(`Eredmény részletei: ID ${resultId}`);
}

function openResults(resultsDir) {
    try {
        const modalEl = document.getElementById('resultsModal');
        const iframe = document.getElementById('resultsModalIframe');
        if (!modalEl || !iframe) {
            alert(resultsDir);
            return;
        }

    // Megpróbáljuk a statikus URL-t használni, hogy a relatív assetek is működjenek
    // A backendünk a /results/<dir>/log.html útvonalon szolgálja ki a fájlt
    let dir = resultsDir || '';
        // Eltávolítjuk a vezető 'results/' vagy 'results' elemet, ha benne van
        dir = dir.replace(/^results[\/]+/, '');

        // Encode each path segment to avoid encoding slashes (which breaks the route)
        const segments = dir.split(/[\/]+/).filter(Boolean);
        const encoded = segments.map(s => encodeURIComponent(s)).join('/');
        const staticUrl = `/results/${encoded}/log.html`;

    console.log('openResults: requesting staticUrl=', staticUrl, 'original resultsDir=', resultsDir);

        // Ha korábban megnyitott eredményablak létezik, zárjuk be azonnal (ne kérdezzünk)
        try {
            if (window._lastResultsWindow && !window._lastResultsWindow.closed) {
                window._lastResultsWindow.close();
            }
        } catch (e) { /* ignore */ }

        // Próbáljuk meg szinkron módon megnyitni a logot — ha sikerül, NE mutassuk a modalt (azonnal bezárjuk a kérdést)
        try {
            const immediate = window.open(staticUrl, '_blank');
            if (immediate) { window._lastResultsWindow = immediate; try { immediate.focus(); } catch(e){}; return; }
        } catch (e) { /* popup blocker or other */ }

        // Mutatjuk a modal-t azonnal és betöltünk egy rövid betöltés üzenetet,
        // most a log fájl elérési útját is megjelenítve a felhasználónak.
        const modal = new bootstrap.Modal(modalEl);
        // Link látható szövegét dekódoljuk, hogy ne jelenjenek meg %-kódok (pl. %C3)
        let visiblePath;
        try {
            visiblePath = decodeURIComponent(staticUrl);
        } catch (e) {
            visiblePath = staticUrl; // ha valamiért nem dekódolható, fallback
        }
        iframe.srcdoc = `
            <div style="padding:20px;font-family:Arial,Helvetica,sans-serif">
                Betöltés…<br>
                <small style="color:#666;">Log: <a href="${staticUrl}" target="_blank" rel="noopener">${visiblePath}</a></small>
            </div>`;
        modal.show();

        // Ellenőrizzük, hogy a fájl elérhető-e (200)
        // Közben a modal footerben található "Megnyitás új lapon" gombot beállítjuk
        const openBtn = document.getElementById('resultsModalOpenNew');
        if (openBtn) {
            openBtn.classList.add('d-none');
            openBtn.onclick = () => {
                const w = window.open(staticUrl, '_blank');
                window._lastResultsWindow = w;
                try { if (w) w.focus(); } catch(e) {}
                try { if (w) modal.hide(); } catch(e) { console.warn('Nem sikerült elrejteni a modalt:', e); }
            };
        }

        // Tároljuk el globálisan is, ha szükséges későbbi megnyitáshoz
        window._lastResultsStaticUrl = staticUrl;

        fetch(staticUrl, { method: 'GET' })
            .then(async resp => {
                if (resp.ok && resp.headers.get('content-type') && resp.headers.get('content-type').includes('text/html')) {
                    // Ha jó, állítsuk be az iframe src-ét, így a relatív hivatkozások is betöltődnek
                    iframe.src = staticUrl;
                    console.log('openResults: loaded ok, set iframe.src');

                    // Show the open-in-new-tab button
                    if (openBtn) {
                        openBtn.classList.remove('d-none');
                    }

                    // Try to open automatically in a new tab (may be blocked if not a user gesture)
                    try {
                        const newWin = window.open(staticUrl, '_blank');
                        if (newWin) {
                            window._lastResultsWindow = newWin;
                            try { newWin.focus(); } catch(e) {}
                            try { modal.hide(); } catch(e) { console.warn('Nem sikerült elrejteni a modalt:', e); }
                        }
                    } catch (e) {
                        // ignore popup blockers
                        console.warn('openResults: auto-open blocked or failed', e);
                    }
                } else {
                    // Ha nem OK, próbáljuk kiolvasni JSON hibát, vagy mutassunk hibát
                    let body = '';
                    try {
                        body = await resp.text();
                    } catch (e) {
                        console.error('openResults: failed to read response body', e);
                    }
                    try {
                        const j = JSON.parse(body || '{}');
                        iframe.srcdoc = `<div style="padding:20px;color:#a00">Hiba: ${j.error || 'Nem található'} (HTTP ${resp.status})</div>`;
                    } catch (e) {
                        iframe.srcdoc = `<div style="padding:20px;color:#a00">Nem sikerült betölteni a log.html (HTTP ${resp.status})</div>`;
                    }
                    console.warn('openResults: response not ok', resp.status, body);
                }
            })
            .catch(err => {
                console.error('Hiba a statikus log lekérésekor', err);
                iframe.srcdoc = `<div style="padding:20px;color:#a00">Hiba a log betöltésekor: ${String(err)}</div>`;
            });
    } catch (e) {
        console.error('openResults hiba:', e);
        alert(resultsDir);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Keresés eseménykezelő
    const searchInput = document.getElementById('searchResults');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                refreshResults();
            }, 500);
        });
    }
    
    // Szűrők eseménykezelői
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', refreshResults);
    }
    
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter) {
        dateFilter.addEventListener('change', refreshResults);
    }
    
    // Eredmények tab aktiválásakor betöltés
    const resultsTab = document.getElementById('results-tab');
    if (resultsTab) {
        resultsTab.addEventListener('shown.bs.tab', function() {
            loadResults();
        });
    }

    // Bootstrap tooltip inicializálás minden elemen, ahol data-bs-toggle="tooltip"
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Konzisztencia-ellenőrzés: csak azok maradjanak a "Futtatható" listában,
    // amelyek ténylegesen telepítve vannak (és van start.bat)
    try { reconcileRunnableWithInstalled(); } catch(e) {
        console.warn('reconcileRunnableWithInstalled hívás sikertelen', e);
    }
});

// Futtatható robotok lista frissítése (újra lekéri és frissíti a DOM-ot)
function refreshRunnableRobots() {
    fetch('/api/refresh')
        .then(r => r.json())
        .then(repos => {
            // Frissítsük a "Futtatható robotok" tab tartalmát
            updateRunnableRobotsTab(repos);
        })
        .catch(err => {
            console.warn('Futtatható robotok frissítése sikertelen:', err);
        });
}

// Futtatható robotok tab tartalmának frissítése
function updateRunnableRobotsTab(repos) {
    const container = document.getElementById('repoContainer');
    if (!container) return;

    // Lekérdezzük a ténylegesen telepített kulcsokat
    fetch('/api/debug/installed')
        .then(r => {
            if (!r.ok) throw new Error('installed debug endpoint not available');
            return r.json();
        })
        .then(data => {
            const installedSet = new Set(data.installed_keys || []);
            
            // Új tartalom építése - csak a telepített robotokkal
            let html = '';
            repos.forEach(repo => {
                const installedBranches = repo.branches ? repo.branches.filter(branch => 
                    installedSet.has(`${repo.name}|${branch}`)
                ) : [];
                
                if (installedBranches.length > 0) {
                    html += `
                        <div class="col-lg-6 col-xl-4 mb-4 repo-item" data-repo-name="${repo.name}">
                            <div class="card repo-card h-100">
                                <div class="card-header text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-github"></i>
                                        <a href="${repo.html_url}" target="_blank" class="text-white text-decoration-none">
                                            ${repo.name}
                                        </a>
                                    </h5>
                                    ${repo.updated_at ? `<small class="opacity-75">${repo.updated_at.slice(0,10)}</small>` : ''}
                                </div>
                                <div class="card-body">
                                    <p class="card-text">${repo.description || 'Nincs leírás'}</p>
                                    <h6 class="mt-3"><i class="bi bi-git"></i> Robotok:</h6>
                                    <div class="branches-container">
                    `;
                    
                    // Csak a telepített branch-ek
                    installedBranches.forEach(branch => {
                        html += `
                            <div class="branch-checkbox d-flex align-items-center" style="margin-bottom: 5px;">
                                <input type="checkbox" class="form-check-input robot-checkbox me-2"
                                       id="branch-${repo.name}-${branch}" 
                                       data-repo="${repo.name}" 
                                       data-branch="${branch}"
                                       onchange="handleRunnableRobotToggle(this)">
                                <div class="d-flex align-items-center me-2">
                                    <i class="bi bi-house-fill text-primary me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Feltöltve: ${repo.pushed_at_formatted || ''}"></i>
                                    <i class="bi bi-trash text-danger" 
                                       style="cursor: pointer;" 
                                       onclick="deleteRunnableBranch('${repo.name}', '${branch}')"
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       title="Eltávolítás a futtathatók közül"></i>
                                </div>
                                <label class="form-check-label mb-0 me-2" for="branch-${repo.name}-${branch}">${branch}</label>
                                <button class="btn btn-success btn-sm ms-2" title="Futtatás"
                                    data-repo="${repo.name}"
                                    data-branch="${branch}"
                                    onclick="executeSingleRobot(this.dataset.repo, this.dataset.branch, ROOT_FOLDER)">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (container) container.innerHTML = html;
            
            // Tooltipek újrainicializálása
            const tooltipTriggerList = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                try { new bootstrap.Tooltip(tooltipTriggerEl); } catch(e) {}
            });
            
            // Tab számok frissítése
            updateTabCounts();
        })
        .catch(err => {
            console.warn('Nem sikerült lekérni a telepített kulcsokat:', err);
        });
}

// Eltávolítja a felületről azokat a futtathatónak jelölt elemeket,
// amelyek nincsenek az Installed/SANDBOX könyvtárban start.bat-tal
function reconcileRunnableWithInstalled() {
    fetch('/api/debug/installed')
        .then(r => {
            if (!r.ok) throw new Error('installed debug endpoint not available');
            return r.json();
        })
        .then(data => {
            const set = new Set((data.installed_keys || []));
            const repoItems = document.querySelectorAll('.repo-item');
            repoItems.forEach(repoEl => {
                const repoName = repoEl.getAttribute('data-repo-name');
                const branches = repoEl.querySelectorAll('.branch-checkbox input.robot-checkbox');
                branches.forEach(inp => {
                    const r = inp.getAttribute('data-repo');
                    const b = inp.getAttribute('data-branch');
                    if (!set.has(`${r}|${b}`)) {
                        const wrapper = inp.closest('.branch-checkbox');
                        if (wrapper) wrapper.remove();
                    }
                });
                // Ha nem maradt branch, az egész kártyát is eltávolítjuk
                if (repoEl.querySelectorAll('.branch-checkbox').length === 0) {
                    repoEl.remove();
                }
            });
        })
        .catch(err => {
            // Ha nincs debug endpoint (régi szerver fut), nem csinálunk semmit
            console.info('Installed debug endpoint nem elérhető vagy hiba történt:', err.message);
        });
}

function deleteBranchFromRunnable(repoName, branchName) {
    fetch('/delete_runnable_branch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            repo: repoName,
            branch: branchName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Távolítsuk el a branch elemet a DOM-ból
            const branchElement = document.getElementById(`branch-${repoName}-${branchName}`).closest('.branch-checkbox');
            if (branchElement) {
                branchElement.remove();
            }
            
            // Ellenőrizzük, hogy van-e még branch a repository-ban
            const repoElement = document.querySelector(`.repo-item[data-repo-name="${repoName}"]`);
            if (repoElement) {
                const remainingBranches = repoElement.querySelectorAll('.branch-checkbox');
                if (remainingBranches.length === 0) {
                    // Ha nincs több branch, távolítsuk el az egész repository kártyát
                    repoElement.remove();
                }
            }
            
            // Frissítsük a futtatás gombot
            updateRunButton();
            
            console.log(`Branch ${repoName}/${branchName} eltávolítva a futtathatók közül`);

            // Frissítsük a Letölthető robotok tabot is
            try {
                addBranchToAvailableTab(repoName, branchName);
            } catch (e) {
                console.warn('Nem sikerült a Letölthető tabot frissíteni, oldal frissítés szükséges lehet.', e);
            }
        } else {
            alert('Hiba történt a branch eltávolításakor: ' + (data.error || 'Ismeretlen hiba'));
        }
    })
    .catch(error => {
        console.error('Hiba:', error);
        alert('Hiba történt a branch eltávolításakor.');
    });
}


// Dinamikus branch hozzáadás logika eltávolítva, nincs többé futtatási/kiválasztási JS

// Globális fallback: Letölthető robotok tab frissítése oldal reload-dal
function refreshAvailableRobots() {
    console.log('[WORKFLOW] Letölthető robotok tab frissítése (reload)');
    window.location.reload();
}

</script>
</body>
</html>
